# Conan Server 权限与审计指南

本项目实现了一套基于角色的精细化访问控制 (RBAC) 和自动化审计系统。

## 1. 角色定义 (Roles)

服务器内置了三种角色，适用于不同的团队协作场景：

| 角色名称       | 关键字      | 查看/搜索/下载 | 上传包 (Recipe & Binary) | 删除包/文件 | 适用人群                       |
| :------------- | :---------- | :------------: | :----------------------: | :---------: | :----------------------------- |
| **超级管理员** | `admin`     |       ✅        |            ✅             |      ✅      | 仓库负责人、运维、CI/CD 管理员 |
| **开发员**     | `developer` |       ✅        |            ✅             |      ❌      | 普通开发、自动化构建机器       |
| **访客/只读**  | `viewer`    |       ✅        |            ❌             |      ❌      | 跨团队合作者、部署采集脚本     |

## 2. 账号管理指令

### 创建/更新用户
使用 `./add-user.sh` 脚本管理用户：
```bash
# 创建开发员
./add-user.sh zhangsan password developer

# 创建只读访客
./add-user.sh guest readonly viewer

# 修改管理员密码 (会自动同步到本地 .env)
./add-user.sh admin MyNewPassword admin
```

## 3. 审计日志 (Audit Logs)

为了安全和合规，所有对仓库产生修改的操作都会被记录到 DynamoDB 中。

### 如何查看日志？
运行根目录下的 `./view-logs.sh` 脚本：
```bash
./view-logs.sh
```

### 日志内容示例：
*   **UPLOAD_RECIPE**: 谁在什么时候上传了哪个库的源码定义。
*   **UPLOAD_PACKAGE**: 谁上传了哪个特定配置的二进制包。
*   **REMOVE_FILES**: 哪个管理员删除了文件。
*   **权限拦截记录**: 如果一个 `viewer` 尝试上传，虽然操作会被 403 拦截，但系统仍会在内部日志中记录此次未授权尝试（如果需要）。

## 4. 成本优化
传统日志方案（如 CloudWatch）按存储量收费。我们的方案：
1.  **高价值日志存 DynamoDB**: 审计日志占用空间极小，在 Free Tier 范围内。
2.  **低价值日志限时删除**: Lambda 的调试日志（CloudWatch）被强制设为 **1天保留期**，系统会自动清理，不会产生长期的“僵尸”存储费用。
